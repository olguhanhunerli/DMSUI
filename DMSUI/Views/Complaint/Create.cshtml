@model DMSUI.ViewModels.Complaint.CreateComplaintVM
@{
    ViewData["Title"] = "Yeni Şikayet";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Yeni Şikayet</h4>
    <a class="btn btn-outline-secondary btn-sm" asp-action="Index">
        <i class="bi bi-arrow-left me-1"></i> Listeye Dön
    </a>
</div>

<form asp-action="Create" method="post" class="card shadow-sm" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="card-body">
        <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

        <div class="row g-2">

            <div class="col-12 col-md-4">
                <label asp-for="CustomerId" class="form-label small text-muted mb-1"></label>
                <select asp-for="CustomerId" asp-items="Model.Customers" class="form-select form-select-sm">
                    <option value="">Seçiniz</option>
                </select>
                <span asp-validation-for="CustomerId" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label small text-muted mb-1">Atananlar</label>
                <select asp-for="AssigneeUserIds"
                        asp-items="Model.Users"
                        class="form-select form-select-sm"
                        multiple
                        size="6"
                        id="assigneesSelect">
                </select>
                <span asp-validation-for="AssigneeUserIds" class="text-danger small"></span>
                <div class="form-text">Ctrl/Command ile çoklu seçebilirsin.</div>
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label small text-muted mb-1">Primary Atanan</label>
                <select asp-for="PrimaryAssigneeUserId" class="form-select form-select-sm" id="primarySelect">
                    <option value="">Seçiniz</option>
                </select>
                <span asp-validation-for="PrimaryAssigneeUserId" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="ChannelId" class="form-label small text-muted mb-1"></label>
                <select asp-for="ChannelId" asp-items="Model.Channels" class="form-select form-select-sm">
                    <option value="">Seçiniz</option>
                </select>
                <span asp-validation-for="ChannelId" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="TypeId" class="form-label small text-muted mb-1"></label>
                <select asp-for="TypeId" asp-items="Model.Types" class="form-select form-select-sm">
                    <option value="">Seçiniz</option>
                </select>
                <span asp-validation-for="TypeId" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="SeverityId" class="form-label small text-muted mb-1"></label>
                <select asp-for="SeverityId" asp-items="Model.Severities" class="form-select form-select-sm" id="severitySelect">
                    <option value="">Seçiniz</option>
                </select>
                <span asp-validation-for="SeverityId" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-4 d-flex align-items-end">
                <div class="form-check mt-2">
                    <input asp-for="IsRepeat" class="form-check-input" id="isRepeatToggle" />
                    <label asp-for="IsRepeat" class="form-check-label"></label>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <label asp-for="Title" class="form-label small text-muted mb-1"></label>
                <input asp-for="Title" class="form-control form-control-sm" />
                <span asp-validation-for="Title" class="text-danger small"></span>
            </div>

            <div class="col-12">
                <label asp-for="Description" class="form-label small text-muted mb-1"></label>
                <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Description" class="text-danger small"></span>
            </div>

            <hr class="my-3" />

            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-1">Ürün / İzlenebilirlik</h6>
                    <span id="traceHint" class="small text-danger d-none">
                        Yüksek/Kritik veya Tekrar şikayetlerde Parça No ve Containment zorunludur.
                    </span>
                </div>
                <div class="text-muted small">Parça/Lot bilgisi denetim ve analiz için önerilir.</div>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="PartNumber" class="form-label small text-muted mb-1"></label>
                <input asp-for="PartNumber" class="form-control form-control-sm" id="partNumberInput" />
                <span asp-validation-for="PartNumber" class="text-danger small"></span>
            </div>

            <div class="col-12 col-md-2">
                <label asp-for="PartRevision" class="form-label small text-muted mb-1"></label>
                <input asp-for="PartRevision" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-3">
                <label asp-for="LotNumber" class="form-label small text-muted mb-1"></label>
                <input asp-for="LotNumber" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-3">
                <label asp-for="SerialNumber" class="form-label small text-muted mb-1"></label>
                <input asp-for="SerialNumber" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-3">
                <label asp-for="ProductionDate" class="form-label small text-muted mb-1"></label>
                <input asp-for="ProductionDate" type="date" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-3">
                <label asp-for="ProductionLine" class="form-label small text-muted mb-1"></label>
                <input asp-for="ProductionLine" class="form-control form-control-sm" />
            </div>

            <hr class="my-3" />

            <div class="col-12">
                <h6 class="mb-1">Müşteri / Sevkiyat</h6>
                <div class="text-muted small">Varsa müşteri referansı ve sevkiyat bilgilerini gir.</div>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="CustomerComplaintNo" class="form-label small text-muted mb-1"></label>
                <input asp-for="CustomerComplaintNo" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="CustomerPO" class="form-label small text-muted mb-1"></label>
                <input asp-for="CustomerPO" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="DeliveryNoteNo" class="form-label small text-muted mb-1"></label>
                <input asp-for="DeliveryNoteNo" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-3">
                <label asp-for="QuantityAffected" class="form-label small text-muted mb-1"></label>
                <input asp-for="QuantityAffected" type="number" min="0" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-9">
                <label asp-for="ContainmentAction" class="form-label small text-muted mb-1"></label>
                <input asp-for="ContainmentAction" class="form-control form-control-sm" id="containmentInput" />
            </div>

            <hr class="my-3" />

            <div class="col-12 col-md-4">
                <div class="form-check mt-2">
                    <input asp-for="InterimActionRequired" class="form-check-input" id="interimToggle" />
                    <label asp-for="InterimActionRequired" class="form-check-label"></label>
                </div>
            </div>

            <div class="col-12 col-md-8" id="interimNoteWrap">
                <label asp-for="InterimActionNote" class="form-label small text-muted mb-1"></label>
                <input asp-for="InterimActionNote" class="form-control form-control-sm" />
            </div>

            <div class="col-12 col-md-6">
                <label class="form-label small text-muted mb-1">Ek Dosya</label>
                <input type="file" name="AttachmentFile" multiple class="form-control form-control-sm" />
            </div>

        </div>
    </div>

    <div class="card-footer bg-white d-flex justify-content-end gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Vazgeç</a>
        <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-check2-circle me-1"></i> Kaydet
        </button>
    </div>
</form>

<script>
    (function () {
        const interimToggle = document.getElementById('interimToggle');
        const interimWrap = document.getElementById('interimNoteWrap');

        function syncInterim() {
            if (!interimToggle || !interimWrap) return;
            interimWrap.style.display = interimToggle.checked ? '' : 'none';
        }
        if (interimToggle) interimToggle.addEventListener('change', syncInterim);
        syncInterim();

        const severity = document.getElementById('severitySelect');
        const isRepeat = document.getElementById('isRepeatToggle');
        const partNumber = document.getElementById('partNumberInput');
        const containment = document.getElementById('containmentInput');
        const hint = document.getElementById('traceHint');

        function isHighSeverity() {
            const v = parseInt((severity && severity.value) ? severity.value : "0", 10);
            return v >= 3;
        }

        function syncTraceRules() {
            const required = isHighSeverity() || (isRepeat && isRepeat.checked);

            if (hint) hint.classList.toggle('d-none', !required);

            if (partNumber) {
                partNumber.required = required;
                partNumber.classList.toggle('is-invalid', required && !partNumber.value.trim());
            }

            if (containment) {
                containment.required = required;
                containment.classList.toggle('is-invalid', required && !containment.value.trim());
            }
        }

        [severity, isRepeat, partNumber, containment].forEach(el => {
            if (!el) return;
            el.addEventListener('change', syncTraceRules);
            el.addEventListener('input', syncTraceRules);
        });

        syncTraceRules();
    })();

    (function () {
        const assignees = document.getElementById('assigneesSelect');
        const primary = document.getElementById('primarySelect');

        function rebuildPrimary() {
            if (!assignees || !primary) return;

            const selected = Array.from(assignees.selectedOptions).map(o => ({
                value: o.value,
                text: o.text
            }));

            const current = primary.value;
            primary.innerHTML = '<option value="">Seçiniz</option>';

            selected.forEach(x => {
                const opt = document.createElement('option');
                opt.value = x.value;
                opt.text = x.text;
                primary.appendChild(opt);
            });

            if (selected.some(x => x.value === current)) {
                primary.value = current;
            } else if (selected.length === 1) {
                primary.value = selected[0].value;
            }
        }

        if (assignees) {
            assignees.addEventListener('change', rebuildPrimary);
            rebuildPrimary();
        }
    })();
</script>
