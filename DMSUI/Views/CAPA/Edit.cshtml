@using DMSUI.Entities.DTOs.CAPA
@using Microsoft.AspNetCore.Mvc.Rendering
@model CAPADetailDTO

@{
    ViewData["Title"] = "CAPA Düzenle";

    string Dts(DateTime d) => d.ToString("dd.MM.yyyy HH:mm");
    string DtsOrDash(DateTime? d) => d.HasValue ? d.Value.ToString("dd.MM.yyyy HH:mm") : "-";

    string Badge(string? durum)
    {
        if (string.IsNullOrWhiteSpace(durum)) return "secondary";
        var s = durum.Trim().ToUpperInvariant();

        return s switch
        {
            "BEKLIYOR" => "warning",
            "AÇIK" or "ACIK" => "info",
            "KAPALI" => "success",
            "RED" or "IPTAL" => "danger",
            _ => "secondary"
        };
    }

    bool kilitli = string.Equals(Model.Status, "KAPALI", StringComparison.OrdinalIgnoreCase);
    int aksiyonSayisi = Model.Actions?.Count ?? 0;
    int currentUserId = int.Parse(User.FindFirst("UserId")!.Value);

    // TagHelper-safe attribute helpers
    string? disabledAttr = kilitli ? "disabled" : null;
}

<div class="container my-4">

    <!-- HEADER -->
    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div>
                <div class="text-muted small">CAPA Numarası</div>
                <h3 class="mb-1">@Model.CapaNo</h3>
                <div class="text-muted">
                    Şikayet:
                    <span class="fw-semibold">@(!string.IsNullOrWhiteSpace(Model.ComplaintNo) ? Model.ComplaintNo : "-")</span>
                </div>
            </div>

            <div class="text-end">
                <div class="mb-2">
                    <span class="badge bg-@Badge(Model.Status) fs-6">@Model.Status</span>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <a class="btn btn-outline-secondary" asp-action="Detail" asp-route-capaNo="@Model.CapaNo">
                        Detay
                    </a>
                </div>
                @if (kilitli)
                {
                    <div class="text-muted small mt-2">Durum “KAPALI” olduğu için düzenleme kilitli.</div>
                }
            </div>
        </div>
    </div>

    <div class="row g-3">

        <!-- LEFT: FORM -->
        <div class="col-lg-8">
            <form id="capaForm" asp-action="Edit" method="post">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="OwnerId" />
                <input type="hidden" asp-for="CapaNo" />
                <input type="hidden" asp-for="Status" />
                <input type="hidden" asp-for="RootCauseMethodId" />

                <!-- GENEL -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header fw-semibold">Genel</div>
                    <div class="card-body">
                        <div class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label">Durum</label>
                                <input type="text" value="@Model.Status" class="form-control" readonly />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Termin</label>
                                <input asp-for="DueDate" type="date" class="form-control" disabled="@disabledAttr" />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Kalan Gün</label>
                                <input asp-for="RemainingDays" class="form-control" readonly />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Sorumlu</label>
                                <input asp-for="OwnerByName" class="form-control" readonly />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Firma</label>
                                <input asp-for="CompanyName" class="form-control" readonly />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Kök Neden Metodu</label>
                                <input type="text" value="@Model.RootCauseMethodName" class="form-control" readonly />
                            </div>

                        </div>
                    </div>
                </div>

                <!-- İÇERİK -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header fw-semibold">İçerik</div>
                    <div class="card-body">

                        <div class="mb-3">
                            <label class="form-label">Uygunsuzluk</label>
                            <textarea asp-for="NonConformity" class="form-control" rows="3" disabled="@disabledAttr"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Kök Neden</label>
                            <textarea asp-for="RootCause" class="form-control" rows="3" disabled="@disabledAttr"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Düzeltici Faaliyet</label>
                            <textarea asp-for="CorrectiveAction" class="form-control" rows="3" disabled="@disabledAttr"></textarea>
                        </div>

                        <div class="mb-0">
                            <label class="form-label">Etkinlik Kontrolü</label>
                            <textarea asp-for="EffectivenessCheck" class="form-control" rows="2" disabled="@disabledAttr"></textarea>
                        </div>

                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a class="btn btn-outline-secondary" asp-action="Index">Listeye Dön</a>
                    <button type="submit" class="btn btn-primary" disabled="@disabledAttr">Kaydet</button>
                </div>
            </form>
        </div>

        <!-- RIGHT: SIDEBAR -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header fw-semibold">Şikayet Bilgileri</div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-5 text-muted">Firma</dt>
                        <dd class="col-7 fw-semibold">@(Model.ComplaintCompanyName ?? "-")</dd>

                        <dt class="col-5 text-muted">Müşteri</dt>
                        <dd class="col-7">@(Model.CustomerName ?? "-")</dd>

                        <dt class="col-5 text-muted">Şikayet No</dt>
                        <dd class="col-7">@(Model.ComplaintNo ?? "-")</dd>

                        <dt class="col-5 text-muted">Müşteri Şikayet No</dt>
                        <dd class="col-7">@(Model.CustomerComplaintNo ?? "-")</dd>

                        <dt class="col-5 text-muted">Müşteri PO</dt>
                        <dd class="col-7">@(Model.CustomerPO ?? "-")</dd>

                        @if (!string.IsNullOrWhiteSpace(Model.ComplaintTitle))
                        {
                            <dt class="col-5 text-muted">Konu</dt>
                            <dd class="col-7">@Model.ComplaintTitle</dd>
                        }
                    </dl>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header fw-semibold">Özet</div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-6 text-muted">Açılış</dt>
                        <dd class="col-6">@Dts(Model.OpenedAt)</dd>

                        <dt class="col-6 text-muted">Kapanış</dt>
                        <dd class="col-6">@DtsOrDash(Model.CloseAt)</dd>

                        <dt class="col-6 text-muted">Oluşturma</dt>
                        <dd class="col-6">@Dts(Model.CreatedAt)</dd>

                        <dt class="col-6 text-muted">Güncelleme</dt>
                        <dd class="col-6">@DtsOrDash(Model.UpdatedAt)</dd>

                        <dt class="col-6 text-muted">Etkinlik Kontrol Tarihi</dt>
                        <dd class="col-6">@DtsOrDash(Model.EffectivenessCheckedAt)</dd>

                        <dt class="col-6 text-muted">Kontrol Eden</dt>
                        <dd class="col-6">@(!string.IsNullOrWhiteSpace(Model.EffectivenessCheckedByName) ? Model.EffectivenessCheckedByName : "-")</dd>
                    </dl>
                </div>
              
            </div>
            <div class="card shadow-sm mb-3">
                <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
                    <span>DÖF Dosyaları</span>

                    <button type="button"
                            class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#dofFileModal">
                        📎 Dosya Ekle
                    </button>
                </div>

                <div class="card-body">

                    <div id="dofFileList">

                        @if (Model.Files?.Any() == true)
                        {
                            foreach (var f in Model.Files)
                            {
                                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                                    <div>
                                        📄 <span class="fw-semibold">@f.FileName</span>
                                        <div class="small text-muted">@f.UploadedAt.ToString("dd.MM.yyyy HH:mm")</div>
                                    </div>
                                    @* <a href="@f.DownloadUrl" target="_blank" class="btn btn-sm btn-outline-secondary"> *@
                                    @*     İndir *@
                                    @* </a> *@
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-muted small" id="noDofFileText">
                                Henüz dosya eklenmemiş.
                            </div>
                        }

                    </div>

                </div>
            </div>

            @if (!kilitli)
            {
                <button type="button" class="btn btn-danger w-100"
                        data-bs-toggle="modal" data-bs-target="#closeCapaModal">
                    CAPA’yı Kapat
                </button>
            }

            <div class="alert alert-light border mt-3 mb-0">
                <div class="fw-semibold mb-1">Hızlı Bilgi</div>
                <div class="small text-muted">
                    Aksiyon Sayısı: <span class="fw-semibold">@aksiyonSayisi</span><br />
                    Firma: <span class="fw-semibold">@Model.CompanyName</span><br />
                    Atanan Kişi: <span class="fw-semibold">@Model.OwnerByName</span>
                </div>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <span>Aksiyonlar</span>
                        <span class="text-muted small">Toplam: @aksiyonSayisi</span>
                    </div>

                    @if (!kilitli)
                    {
                        <button type="button" class="btn btn-sm btn-success"
                                data-bs-toggle="modal" data-bs-target="#addActionModal">
                            ➕ Yeni Aksiyon
                        </button>
                    }
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:70px;">#</th>
                                    <th>Tip</th>
                                    <th>Açıklama</th>
                                    <th>Sahip</th>
                                    <th>Termin</th>
                                    <th>Durum</th>
                                    <th>Kanıt</th>
                                    <th>Oluşturma</th>
                                    <th>Dosyalar</th>
                                </tr>
                            </thead>

                            <tbody id="actionsTbody">
                                @if (Model.Actions?.Any() != true)
                                {
                                    <tr data-empty-row="true">
                                        <td colspan="8" class="text-center text-muted py-4">Aksiyon yok.</td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var a in Model.Actions)
                                    {
                                        <tr>
                                            <td>@a.Id</td>
                                            <td>@a.ActionType</td>
                                            <td>@a.Description</td>
                                            <td>@(a.OwnerName ?? "-")</td>
                                            <td>@Dts(a.DueDate)</td>
                                            <td>
                                                @if (!kilitli && a.OwnerId == currentUserId && !string.Equals(a.Status, "TAMAMLANDI", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <div class="d-flex gap-2 align-items-center">
                                                        <select class="form-select form-select-sm action-status"
                                                                data-action-id="@a.Id"
                                                                data-prev="@a.Status">
                                                            <option value="BEKLIYOR" selected="@(string.Equals(a.Status, "BEKLIYOR", StringComparison.OrdinalIgnoreCase))">BEKLIYOR</option>
                                                            <option value="AÇIK" selected="@(string.Equals(a.Status, "AÇIK", StringComparison.OrdinalIgnoreCase) || string.Equals(a.Status, "ACIK", StringComparison.OrdinalIgnoreCase))">AÇIK</option>
                                                            <option value="KAPALI" selected="@(string.Equals(a.Status, "KAPALI", StringComparison.OrdinalIgnoreCase))">KAPALI</option>
                                                            <option value="RED" selected="@(string.Equals(a.Status, "RED", StringComparison.OrdinalIgnoreCase))">RED</option>
                                                        </select>

                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-primary action-status-save"
                                                                data-action-id="@a.Id">
                                                            Kaydet
                                                        </button>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-@Badge(a.Status)">@a.Status</span>
                                                }
                                            </td>
                                            <td>@(a.EvidenceRequired ? "Evet" : "Hayır")</td>
                                            <td>@Dts(a.CreatedAt)</td>
                                            <td>
                                                @if (a.Files?.Any() == true)
                                                {
                                                    <ul class="list-unstyled mb-0">
                                                        @foreach (var f in a.Files)
                                                        {
                                                            <li class="small">
                                                                📎 <span class="fw-semibold">@f.FileName</span>
                                                                <div class="text-muted">@f.UploadedAt.ToString("dd.MM.yyyy HH:mm")</div>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

@if (!kilitli)
{
    <!-- CLOSE CAPA MODAL -->
    <div class="modal fade" id="closeCapaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">CAPA Kapat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <form asp-action="CloseCapa" asp-controller="CAPA" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="capaNo" value="@Model.CapaNo" />

                    <div class="modal-body">
                        <div class="row g-3">

                            <div class="col-12">
                                <label class="form-label">Kapanış Kanıtı</label>
                                <textarea name="ClosureEvidence" class="form-control" rows="2" required></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Etkinlik Sonucu</label>
                                <input name="EffectivenessResult" class="form-control"
                                       placeholder="Başarılı / Başarısız / Kısmi" required />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Etkinlik Kontrol Tarihi</label>
                                <input name="EffectivenessCheckedAt" type="datetime-local"
                                       class="form-control" required />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Etkinlik Kontrolü</label>
                                <textarea name="EffectivenessCheck" class="form-control" rows="2" required></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Kontrol Eden</label>
                                <select name="EffectivenessCheckedBy" class="form-select" required>
                                    <option value="">Seçiniz</option>
                                    @foreach (var u in (ViewBag.Users as List<SelectListItem>) ?? new List<SelectListItem>())
                                    {
                                        <option value="@u.Value" selected="@(u.Value == currentUserId.ToString())">@u.Text</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-6 d-flex align-items-end">
                                <div class="text-muted small">
                                    Bu işlem CAPA durumunu <b>KAPALI</b> yapar.
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Vazgeç</button>
                        <button type="submit" class="btn btn-danger">Onayla & Kapat</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <!-- ADD ACTION MODAL -->
    <div class="modal fade" id="addActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Yeni Aksiyon Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <form id="addActionForm" asp-action="AddAction" asp-controller="CAPA" method="post">
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="capaNo" value="@Model.CapaNo" />

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Tip</label>
                                <select name="ActionType" class="form-select" required>
                                    <option value="">Seçiniz</option>
                                    <option value="TEST">Test</option>
                                    <option value="CORRECTIVE">Düzeltici</option>
                                    <option value="PREVENTIVE">Önleyici</option>
                                </select>
                            </div>

                            <div class="col-md-5">
                                <label class="form-label">Açıklama</label>
                                <input name="Description" class="form-control" required />
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Sahip</label>
                                <select name="OwnerId" class="form-select" required>
                                    <option value="">Seçiniz</option>
                                    @foreach (var u in (ViewBag.Users as List<SelectListItem>) ?? new List<SelectListItem>())
                                    {
                                        <option value="@u.Value">@u.Text</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Termin</label>
                                <input name="DueDate"
                                       type="datetime-local"
                                       class="form-control"
                                       min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                                       required />
                            </div>

                            <div class="col-12">
                                <div class="form-check">
                                    <input name="EvidenceRequired"
                                           class="form-check-input"
                                           type="checkbox"
                                           value="true"
                                           id="evidenceRequiredChk" />
                                    <label class="form-check-label" for="evidenceRequiredChk">Kanıt gerekli</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-success">Ekle</button>
                    </div>

                </form>

            </div>
        </div>
    </div>
}

<!-- KAPALI - FILE UPLOAD MODAL -->
<div class="modal fade" id="kapaliModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">KAPALI için dosya yükle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="kapaliActionId" />
                <input class="form-control" type="file" id="kapaliFile" />
                <div class="small text-muted mt-2">
                    Dosya yüklenmeden işlem tamamlanmaz.
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Vazgeç</button>
                <button class="btn btn-primary" type="button" id="kapaliDevam">Yükle & Tamamla</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="dofFileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">DÖF Dosya Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>

            <div class="modal-body">
                <input class="form-control" type="file" id="dofFile" />
                <div class="small text-muted mt-2">
                    Seçtiğin dosya CAPA’ya eklenecek.
                </div>
                <div class="small text-danger mt-2 d-none" id="dofErr"></div>
                <div class="small text-success mt-2 d-none" id="dofOk">Dosya yüklendi ✅</div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Vazgeç</button>
                <button class="btn btn-primary" type="button" id="dofUploadBtn">Yükle</button>
            </div>

        </div>
    </div>
</div>
@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

  // -----------------------------
  // Bootstrap kontrol
  // -----------------------------
  if (!window.bootstrap) {
    console.error("Bootstrap JS yok. Modal çalışmaz (bootstrap.bundle.min.js gerekli).");
    return;
  }

  // -----------------------------
  // Helpers
  // -----------------------------
  function pad2(n) { return String(n).padStart(2, '0'); }

  function formatDateTime(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}.${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function normalizeStatus(s) {
    return (s || '')
      .toString()
      .trim()
      .toUpperCase()
      .replaceAll('İ', 'I')
      .replaceAll('ı', 'I')
      .replaceAll('Ğ', 'G').replaceAll('ğ', 'G')
      .replaceAll('Ş', 'S').replaceAll('ş', 'S')
      .replaceAll('Ü', 'U').replaceAll('ü', 'U')
      .replaceAll('Ö', 'O').replaceAll('ö', 'O')
      .replaceAll('Ç', 'C').replaceAll('ç', 'C');
  }

  function badgeClassByStatus(norm) {
    switch (norm) {
      case 'BEKLIYOR': return 'warning';
      case 'ACIK': return 'info';
      case 'KAPALI':
      case 'TAMAMLANDI': return 'success';
      case 'RED':
      case 'IPTAL': return 'danger';
      default: return 'secondary';
    }
  }

  async function safeJsonOrText(res) {
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const raw = await res.text();
    if (ct.includes("application/json")) {
      try { return { json: JSON.parse(raw), raw }; } catch { return { json: null, raw }; }
    }
    return { json: null, raw };
  }

  // -----------------------------
  // 1) KAPALI seçilince upload akışı (Aksiyon dosyası)
  // -----------------------------
  const kapaliModalEl = document.getElementById("kapaliModal");
  const kapaliModal = kapaliModalEl ? bootstrap.Modal.getOrCreateInstance(kapaliModalEl) : null;

  let pending = null;

  document.addEventListener("change", (e) => {
    const sel = e.target.closest(".action-status");
    if (!sel) return;

    if ((sel.value || "").toUpperCase() !== "KAPALI") return;

    pending = {
      sel,
      prev: sel.dataset.prev || "",
      actionId: sel.dataset.actionId
    };

    const fileInput = document.getElementById("kapaliFile");
    if (fileInput) fileInput.value = "";

    kapaliModal?.show();
  });

  kapaliModalEl?.addEventListener("hidden.bs.modal", () => {
    if (!pending) return;
    try { pending.sel.value = pending.prev; } catch {}
    pending = null;
  });

  const kapaliDevamBtn = document.getElementById("kapaliDevam");
  kapaliDevamBtn?.addEventListener("click", async () => {
    if (!pending) return;

    const actionId = pending.actionId;
    const file = document.getElementById("kapaliFile")?.files?.[0];

    if (!file) { alert("Dosya seçmelisin."); return; }

    const fd = new FormData();
    // UploadFiles(int actionId, IFormFile file) => "file"
    fd.append("file", file);

    kapaliDevamBtn.disabled = true;

    try {
      const up = await fetch(`/CAPA/UploadFiles?actionId=${encodeURIComponent(actionId)}`, {
        method: "POST",
        body: fd
      });

      if (!up.ok) {
        const t = await up.text().catch(() => null);
        alert(t || "Dosya yüklenemedi.");
        return;
      }

      const comp = await fetch(`/CAPA/ComplateAction?actionId=${encodeURIComponent(actionId)}&status=KAPALI`, {
        method: "POST"
      });

      if (!comp.ok) {
        const t = await comp.text().catch(() => null);
        alert(t || "Tamamlama başarısız.");
        return;
      }

      pending.sel.dataset.prev = "KAPALI";
      pending.sel.value = "KAPALI";

      const container = pending.sel.closest("div.d-flex") || pending.sel.parentElement;
      if (container) container.innerHTML = `<span class="badge bg-success">KAPALI</span>`;
      else pending.sel.disabled = true;

      pending = null;
      kapaliModal?.hide();

    } catch (err) {
      console.error(err);
      alert("İşlem sırasında hata oluştu.");
    } finally {
      kapaliDevamBtn.disabled = false;
    }
  });

  // -----------------------------
  // 2) Add Action AJAX
  // -----------------------------
  const addActionForm = document.getElementById("addActionForm");
  if (addActionForm) {
    addActionForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = addActionForm.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;

      try {
        const formData = new FormData(addActionForm);

        const res = await fetch(addActionForm.action, {
          method: "POST",
          body: formData,
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        const { json: payload, raw } = await safeJsonOrText(res);

        if (!res.ok || !payload || payload.ok !== true) {
          console.error("AddAction status:", res.status);
          console.error("AddAction raw:", raw);
          alert(payload?.message || raw || "Aksiyon eklenemedi.");
          return;
        }

        const a = payload.data;
        const tbody = document.getElementById("actionsTbody");
        if (!tbody || !a) return;

        const emptyRow = tbody.querySelector('[data-empty-row="true"]');
        if (emptyRow) emptyRow.remove();

        const ownerSelect = addActionForm.querySelector('select[name="OwnerId"]');
        const ownerNameFromSelect = ownerSelect?.selectedOptions?.[0]?.textContent?.trim() || '-';

        const normStatus = normalizeStatus(a.status);
        const badgeClass = badgeClassByStatus(normStatus);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.id ?? ''}</td>
          <td>${escapeHtml(a.actionType ?? '')}</td>
          <td>${escapeHtml(a.description ?? '')}</td>
          <td>${escapeHtml(a.ownerName ?? ownerNameFromSelect)}</td>
          <td>${formatDateTime(a.dueDate)}</td>
          <td><span class="badge bg-${badgeClass}">${escapeHtml(normStatus)}</span></td>
          <td>${a.evidenceRequired ? 'Evet' : 'Hayır'}</td>
          <td>${formatDateTime(a.createdAt)}</td>
        `;

        tbody.prepend(tr);

        const addActionModalEl = document.getElementById("addActionModal");
        const modal2 = bootstrap.Modal.getInstance(addActionModalEl) || new bootstrap.Modal(addActionModalEl);
        modal2.hide();

        addActionForm.reset();
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  }

  // -----------------------------
  // 3) DÖF Dosya Upload (CAPA files)
  // -----------------------------
  const dofUploadBtn = document.getElementById("dofUploadBtn");
  const dofFileInput = document.getElementById("dofFile");
  const dofErr = document.getElementById("dofErr");
  const dofOk = document.getElementById("dofOk");

  function showDofErr(msg) {
    if (dofErr) { dofErr.textContent = msg; dofErr.classList.remove("d-none"); }
    if (dofOk) dofOk.classList.add("d-none");
  }

  function showDofOk() {
    if (dofOk) dofOk.classList.remove("d-none");
    if (dofErr) dofErr.classList.add("d-none");
  }

  dofUploadBtn?.addEventListener("click", async () => {
    const file = dofFileInput?.files?.[0];
    if (!file) { showDofErr("Dosya seçmelisin."); return; }

    dofUploadBtn.disabled = true;

    try {
      const fd = new FormData();

      // !!!!! EN ÖNEMLİ DÜZELTME !!!!!
      // Controller: UploadDofFile(string capaNo, IFormFile File) => "File"
      fd.append("File", file);

      const capaNo = "@Model.CapaNo";

      const res = await fetch(`/CAPA/UploadDofFile?capaNo=${encodeURIComponent(capaNo)}`, {
        method: "POST",
        body: fd
      });

      if (!res.ok) {
        const t = await res.text().catch(() => null);
        showDofErr(t || "Dosya yüklenemedi.");
        return;
      }

      const list = document.getElementById("dofFileList");
      const emptyText = document.getElementById("noDofFileText");
      if (emptyText) emptyText.remove();

      if (list) {
        const now = new Date();
        const formatted =
          now.toLocaleDateString("tr-TR") + " " +
          now.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });

        const div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center border rounded p-2 mb-2";
        div.innerHTML = `
          <div>
            📄 <span class="fw-semibold">${escapeHtml(file.name)}</span>
            <div class="small text-muted">${formatted}</div>
          </div>
          <span class="badge bg-success">Yüklendi</span>
        `;
        list.prepend(div);
      }

      showDofOk();
      if (dofFileInput) dofFileInput.value = "";

      const dofModalEl = document.getElementById("dofFileModal");
      const dofModal = bootstrap.Modal.getInstance(dofModalEl);
      dofModal?.hide();

    } catch (e) {
      console.error(e);
      showDofErr("İşlem sırasında hata oluştu.");
    } finally {
      dofUploadBtn.disabled = false;
    }
  });

});
</script>
}

