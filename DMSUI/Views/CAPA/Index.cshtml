@using DMSUI.Entities.DTOs.CAPA
@using DMSUI.Entities.DTOs.Common
@model PagedResultDTO<CAPADTO>

@{
    ViewData["Title"] = "CAPA";
}

<div class="container-fluid px-3 pb-4">

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h4 class="fw-bold mb-0">
            <i class="bi bi-clipboard2-check me-2 text-primary"></i>
            DÖF Listesi
        </h4>

        <button type="button" class="btn btn-primary btn-sm shadow-sm"
                id="btnNewCapa"
                data-bs-toggle="modal"
                data-bs-target="#newCapaModal">
            <i class="bi bi-plus-circle me-1"></i>
            Yeni CAPA
        </button>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-2">

            <div class="table-scroll-x">
                <table class="table table-hover align-middle mb-0 small w-100">
                    <thead class="table-light text-nowrap">
                        <tr>
                            <th>#</th>
                            <th>CAPA No</th>
                            <th>Sahip</th>
                            <th>Durum</th>
                            <th>Kalan Gün</th>
                            <th>Bitiş Tarihi</th>
                            <th>Açılış</th>
                            <th class="text-end">İşlemler</th>
                        </tr>
                    </thead>

                    <tbody class="text-nowrap">

                        @if (Model == null || Model.Items == null || !Model.Items.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                    Kayıt bulunamadı
                                </td>
                            </tr>
                        }
                        else
                        {
                            int rowNo = (Model.Page - 1) * Model.PageSize + 1;

                            foreach (var capa in Model.Items)
                            {
                                string statusClass = capa.Status switch
                                {
                                    "OPEN" => "bg-primary",
                                    "CLOSED" => "bg-success",
                                    "PENDING" => "bg-warning text-dark",
                                    _ => "bg-secondary"
                                };

                                string remainingClass =
                                capa.RemainingDays < 0 ? "text-danger fw-semibold" :
                                capa.RemainingDays <= 3 ? "text-warning fw-semibold" :
                                "text-success fw-semibold";
                                <tr>
                                    <td>@rowNo</td>

                                    <td class="fw-semibold">
                                        @capa.CapaNo
                                        <div class="small text-muted">
                                            @capa.ComplaintNo
                                        </div>
                                    </td>

                                    <td>
                                        @capa.OwnerByName
                                    </td>

                                    <td>
                                        <span class="badge @statusClass">
                                            @capa.Status
                                        </span>
                                    </td>

                                    <td>
                                        <span class="@remainingClass">
                                            @capa.RemainingDays
                                        </span>
                                    </td>

                                    <td>
                                        @capa.DueDate.ToString("dd.MM.yyyy")
                                    </td>

                                    <td>
                                        @capa.OpenedAt.ToString("dd.MM.yyyy HH:mm")
                                    </td>

                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm shadow-sm">
                                            <a asp-action="Details"
                                               asp-route-id="@capa.Id"
                                               class="btn btn-light border"
                                               title="Detay">
                                                <i class="bi bi-eye"></i>
                                            </a>

                                            <a asp-action="Edit"
                                               asp-route-id="@capa.Id"
                                               class="btn btn-light border"
                                               title="Düzenle">
                                                <i class="bi bi-pencil-square text-primary"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>

                                rowNo++;
                            }
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    @if (Model.TotalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination pagination-sm justify-content-end mb-0">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link"
                           asp-route-page="@i"
                           asp-route-pageSize="@Model.PageSize">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }

</div>
<div class="modal fade" id="newCapaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="get" asp-action="Create" asp-controller="CAPA">
                <input type="hidden" name="complaintNo" id="SelectedComplaintNo" />
                <div class="modal-header">
                    <h5 class="modal-title">Yeni DÖF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Şikayet Seç</label>

                        <select class="form-select" id="complaintSelect" name="ComplaintSelectUi">
                            <option value="">Yükleniyor...</option>
                        </select>

                        <small class="text-danger d-none" id="complaintSelectError"></small>
                    </div>

                    <input type="hidden" name="SelectedComplaintId" id="SelectedComplaintId" />
                    <input type="hidden" name="SelectedComplaintNo" id="SelectedComplaintNo" />

                    <div id="complaintDetailArea" class="d-none">
                        <hr />

                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Complaint No</label>
                                <input type="text" class="form-control" id="detailComplaintNo" readonly />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Reported At</label>
                                <input type="text" class="form-control" id="detailReportedAt" readonly />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-control" id="detailTitle" readonly />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Customer</label>
                                <input type="text" class="form-control" id="detailCustomer" readonly />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Severity</label>
                                <input type="text" class="form-control" id="detailSeverity" readonly />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                    <button type="submit" class="btn btn-success">Devam Et</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const modalEl = document.getElementById('newCapaModal');
    const selectEl = document.getElementById('complaintSelect');
    const errEl = document.getElementById('complaintSelectError');

    const hiddenId = document.getElementById('SelectedComplaintId');
    const hiddenNo = document.getElementById('SelectedComplaintNo');

    const detailArea = document.getElementById('complaintDetailArea');
    const detailComplaintNo = document.getElementById('detailComplaintNo');
    const detailTitle = document.getElementById('detailTitle');
    const detailCustomer = document.getElementById('detailCustomer');
    const detailSeverity = document.getElementById('detailSeverity');
    const detailReportedAt = document.getElementById('detailReportedAt');

    function clearDetails() {
        hiddenId.value = '';
        hiddenNo.value = '';

        detailArea.classList.add('d-none');
        detailComplaintNo.value = '';
        detailTitle.value = '';
        detailCustomer.value = '';
        detailSeverity.value = '';
        detailReportedAt.value = '';
    }

    function formatDateTR(isoDate) {
        if (!isoDate) return '';
        const d = new Date(isoDate);
        if (isNaN(d.getTime())) return isoDate;
        return d.toLocaleString('tr-TR');
    }

    async function loadComplaints() {
        errEl.classList.add('d-none');
        errEl.textContent = '';
        selectEl.innerHTML = `<option value="">Yükleniyor...</option>`;

        try {
            const resp = await fetch(`/CAPA/GetComplaintSelectItems?search=&take=50`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            if (!resp.ok) {
                throw new Error(`Liste çekilemedi. Status: ${resp.status}`);
            }

            const data = await resp.json();

            if (!data || data.length === 0) {
                selectEl.innerHTML = `<option value="">Kayıt bulunamadı</option>`;
                return;
            }

            selectEl.innerHTML = `<option value="">Seçiniz...</option>` +
                data.map(x => `
                    <option
                        value="${x.id}"
                        data-complaintno="${(x.complaintNo ?? '').replaceAll('"','&quot;')}"
                        data-title="${(x.title ?? '').replaceAll('"','&quot;')}"
                        data-customer="${(x.customerName ?? '').replaceAll('"','&quot;')}"
                        data-severity="${x.severityId}"
                        data-reportedat="${x.reportedAt}">
                        ${x.complaintNo} - ${x.customerName}
                    </option>
                `).join('');

        } catch (e) {
            selectEl.innerHTML = `<option value="">Hata</option>`;
            errEl.textContent = e.message || 'Bilinmeyen hata';
            errEl.classList.remove('d-none');
        }
    }

    modalEl.addEventListener('shown.bs.modal', () => {
        clearDetails();
        loadComplaints();
    });

    selectEl.addEventListener('change', () => {
        const opt = selectEl.options[selectEl.selectedIndex];

        if (!opt || !opt.value) {
            clearDetails();
            return;
        }

        hiddenId.value = opt.value;
        hiddenNo.value = opt.dataset.complaintno || '';

        detailArea.classList.remove('d-none');
        detailComplaintNo.value = opt.dataset.complaintno || '';
        detailTitle.value = opt.dataset.title || '';
        detailCustomer.value = opt.dataset.customer || '';
        detailSeverity.value = opt.dataset.severity || '';
        detailReportedAt.value = formatDateTR(opt.dataset.reportedat);
    });
</script>