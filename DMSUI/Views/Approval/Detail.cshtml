@model DocumentDetailDTO
@using DMSUI.Entities.DTOs.Document
@using DMSUI.Extensions

@{
    ViewData["Title"] = "Doküman Detayı";
    var currentUserId = User.GetUserId();
    bool canApprove = Model.CurrentApproverId == currentUserId;
}

<div class="container-fluid px-4 mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="fw-bold mb-0">@Model.DocumentCode</h4>
            <small class="text-muted">@Model.Title</small>
        </div>

        <span class="badge fs-6
            @(Model.StatusId == 1 ? "bg-warning text-dark" :
              Model.StatusId == 2 ? "bg-success" :
              Model.StatusId == 3 ? "bg-danger" : "bg-secondary")">
            @Model.Status
        </span>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-info">
                Doküman Bilgileri
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pdf">
                PDF
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-approval">
                Onay
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history">
                Geçmiş
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-logs">
                Loglar
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- INFO TAB -->
        <div class="tab-pane fade show active" id="tab-info">
            <div class="card mb-3">
                <div class="card-body row g-3">
                    <div class="col-md-3"><strong>Tip</strong><br />@Model.DocumentType</div>
                    <div class="col-md-3"><strong>Versiyon</strong><br />@Model.VersionNumber</div>
                    <div class="col-md-3"><strong>Oluşturan</strong><br />@Model.CreatedByName</div>
                    <div class="col-md-3"><strong>Tarih</strong><br />@Model.CreatedAt?.ToString("dd.MM.yyyy HH:mm")</div>

                    <div class="col-md-12">
                        <strong>Versiyon Notu</strong><br />
                        @(string.IsNullOrWhiteSpace(Model.VersionNote) ? "-" : Model.VersionNote)
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Ana Dosya</div>
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-file-earmark-text"></i>
                        @Model.MainFile?.OriginalFileName
                        <small class="text-muted ms-2">
                            (@(Model.MainFile?.FileSize / 1024) KB)
                        </small>
                    </div>

                    <a href="@Url.Action("Pdf", "Document", new { id = Model.Id })"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary">
                        PDF Aç
                    </a>
                </div>
            </div>
        </div>

        <!-- PDF TAB -->
        <div class="tab-pane fade" id="tab-pdf">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>PDF Önizleme</strong>

                    <a href="@Url.Action("Pdf", "Document", new { id = Model.Id })"
                       target="_blank"
                       class="btn btn-sm btn-outline-secondary">
                        Yeni Sekmede Aç
                    </a>
                </div>

                <div class="card-body p-0" style="height:80vh;">
                    <iframe src="@Url.Action("Pdf", "Document", new { id = Model.Id })"
                            style="width:100%; height:100%; border:none;">
                    </iframe>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-approval">

            <div class="card mb-3">
                <div class="card-body">

                    <h6 class="mb-3">Onay Durumu</h6>

                    @if (Model.StatusId == 1)
                    {
                        <div class="alert alert-warning d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Bekleyen Onaycı:</strong>
                                @Model.CurrentApproverName
                            </div>

                            @if (canApprove)
                            {
                                <span class="badge bg-success">
                                    Bu doküman senin onayında
                                </span>
                            }
                        </div>
                    }

                    @if (Model.StatusId == 2)
                    {
                        <div class="alert alert-success">
                            <strong>Onaylandı:</strong> @Model.ApprovedByName
                        </div>
                    }

                    @if (Model.StatusId == 3)
                    {
                        <div class="alert alert-danger">
                            <strong>Reddedildi:</strong> @Model.RejectedByName <br />
                            <strong>Gerekçe:</strong> @Model.RejectReason
                        </div>
                    }
                </div>
            </div>
            @if (canApprove && Model.StatusId == 1)
            {
                <div class="card border-warning">
                    <div class="card-body">

                        <h6 class="mb-3 text-warning">
                            <i class="bi bi-exclamation-circle"></i>
                            Bu doküman senin onayında
                        </h6>

                        <form asp-action="Approve" method="post" class="d-inline">
                            <input type="hidden" name="documentId" value="@Model.Id" />
                            <button class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Onayla
                            </button>
                        </form>

                        <button class="btn btn-danger btn-lg ms-2"
                                data-bs-toggle="collapse"
                                data-bs-target="#rejectBox">
                            <i class="bi bi-x-circle"></i> Reddet
                        </button>

                        <div id="rejectBox" class="collapse mt-3">
                            <form asp-action="Reject" method="post">
                                <input type="hidden" name="documentId" value="@Model.Id" />
                                <textarea name="reason"
                                          class="form-control mb-2"
                                          rows="3"
                                          required
                                          placeholder="Red gerekçesi"></textarea>
                                <button class="btn btn-danger">Reddet ve Gönder</button>
                            </form>
                        </div>

                    </div>
                </div>
            }
            else if (Model.StatusId == 1)
            {
                <div class="alert alert-info">
                    Bu doküman şu an senin onayında değil.
                </div>
            }

        </div>

        <!-- HISTORY TAB -->
        <div class="tab-pane fade" id="tab-history">
            @if (Model.ApprovalHistories?.Any() == true)
            {
                <ul class="list-group">
                    @foreach (var h in Model.ApprovalHistories)
                    {
                        <li class="list-group-item">
                            <strong>@h.ActionType</strong> - @h.ActionByName
                            <br />
                            <small class="text-muted">
                                @h.ActionAt?.ToString("dd.MM.yyyy HH:mm")
                            </small>
                        </li>
                    }
                </ul>
            }
            else
            {
                <span class="text-muted">Kayıt yok</span>
            }
        </div>

        <!-- LOGS TAB -->
        <div class="tab-pane fade" id="tab-logs">
            @if (Model.AccessLogs?.Any() == true)
            {
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Kullanıcı</th>
                            <th>İşlem</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.AccessLogs)
                        {
                            <tr>
                                <td>@log.UserName</td>
                                <td>@log.AccessType</td>
                                <td>@log.AccessAt?.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <span class="text-muted">Log yok</span>
            }
        </div>

    </div>
</div>
