@using DMSUI.ViewModels
@using DMSUI.ViewModels.User
@model List<UserViewModel>

@{
    ViewData["Title"] = "Kullanıcılar";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
}

<div class="mt-0 pt-0 px-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-semibold mb-0">Kullanıcılar</h5>

        <a asp-controller="User" asp-action="CreateUser"
           class="btn btn-primary btn-sm px-3">
            <i class="bi bi-plus-circle me-1"></i> Yeni Kullanıcı
        </a>
    </div>

    <form method="get" asp-action="Index" class="row g-2 mb-3">

        <div class="col-md-3">
            <input name="Keyword"
                   value="@(ViewBag.SearchRequest?.Keyword ?? "")"
                   class="form-control form-control-sm"
                   placeholder="Ad, kullanıcı adı, email..." />
        </div>

        <div class="col-md-2">
            <select name="RoleId" class="form-select form-select-sm">
                <option value="">Rol</option>
                @foreach (var r in ViewBag.Roles)
                {
                    <option value="@r.Id"
                            selected="@(ViewBag.SearchRequest?.RoleId == r.Id)">
                        @r.Name
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select name="DepartmentId" class="form-select form-select-sm">
                <option value="">Departman</option>
                @foreach (var d in ViewBag.Departments)
                {
                    <option value="@d.Id"
                            selected="@(ViewBag.SearchRequest?.DepartmentId == d.Id)">
                        @d.Name
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select name="CompanyId" class="form-select form-select-sm">
                <option value="">Şirket</option>
                @foreach (var c in ViewBag.Companies)
                {
                    <option value="@c.Id"
                            selected="@(ViewBag.SearchRequest?.CompanyId == c.Id)">
                        @c.Name
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select name="IsActive" class="form-select form-select-sm">
                <option value="">Durum</option>
                <option value="true" selected="@(ViewBag.SearchRequest?.IsActive == true)">Aktif</option>
                <option value="false" selected="@(ViewBag.SearchRequest?.IsActive == false)">Pasif</option>
            </select>
        </div>

        <div class="col-md-1">
            <button class="btn btn-primary btn-sm w-100">
                Ara
            </button>
        </div>

    </form>

    <div class="card shadow-sm border-0">
        <div class="card-body p-2 table-responsive table-scroll-x">

            <table class="table table-hover align-middle mb-0 small w-100">
                <thead class="table-light text-nowrap">
                    <tr>
                        <th class="px-3">#</th>
                        <th class="px-3">Ad Soyad</th>
                        <th class="px-3">Kullanıcı Adı</th>
                        <th class="px-3">Email</th>
                        <th class="px-3">Telefon</th>
                        <th class="px-3">Rol</th>
                        <th class="px-3">Departman</th>
                        <th class="px-3">Şirket</th>
                        <th class="px-3">Pozisyon</th>
                        <th class="px-3">Yönetici</th>
                        <th class="px-3 text-center">Onay</th>
                        <th class="px-3 text-center">Durum</th>
                        <th class="px-3 text-end">İşlemler</th>
                    </tr>
                </thead>

                <tbody class="text-nowrap">

                    @{
                        int rowNo = 1;   
                    }

                    @foreach (var user in Model)
                    {
                        <tr>
                            <td class="px-3">@rowNo</td>

                            <td class="fw-semibold px-3">
                                @user.FirstName @user.LastName
                            </td>

                            <td class="px-3">@user.UserName</td>
                            <td class="px-3">@user.Email</td>
                            <td class="px-3">@user.PhoneNumber</td>

                            <td class="px-3">
                                <span class="badge bg-secondary px-2 py-1">
                                    @user.RoleName
                                </span>
                            </td>

                            <td class="px-3">@user.DepartmentName</td>
                            <td class="px-3">@user.CompanyName</td>
                            <td class="px-3">@(@user.PositionName ?? "-")</td>
                            <td class="px-3">@(@user.ManagerName ?? "-")</td>

                            <td class="px-3 text-center">
                                @if (user.CanApprove)
                                {
                                    <span class="badge bg-success px-2">Lv @user.ApprovalLevel</span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-muted border px-2">Yok</span>
                                }
                            </td>

                            <td class="px-3 text-center">
                                <button type="button"
                                        class="btn btn-sm @(user.IsActive ? "btn-success" : "btn-danger")"
                                        onclick="toggleUserStatus(@user.Id, @(user.IsActive.ToString().ToLower()))">
                                    @(user.IsActive ? "Aktif" : "Pasif")
                                </button>
                            </td>

                            <td class="px-3 text-end">
                                <div class="btn-group btn-group-sm shadow-sm" role="group">
                                    <a asp-controller="User"
                                       asp-action="ChangePassword"
                                       asp-route-email="@user.Email"
                                       class="btn btn-light border"
                                       title="Şifre Değiştir">
                                        <i class="bi bi-key text-warning"></i>
                                    </a>
                                    <a asp-controller="User"
                                       asp-action="Edit"
                                       asp-route-id="@user.Id"
                                       class="btn btn-light border"
                                       title="Düzenle">
                                        <i class="bi bi-pencil-square text-primary"></i>
                                    </a>

                                    <button onclick="deleteUser(@user.Id)"
                                            class="btn btn-light border"
                                            title="Sil">
                                        <i class="bi bi-trash text-danger"></i>
                                    </button>

                                </div>
                            </td>
                        </tr>

                        rowNo++;  
                    }

                </tbody>
            </table>

        </div>
    </div>

    <nav class="mt-3">
        <ul class="pagination pagination-sm justify-content-end">

            @if (currentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(currentPage - 1)"
                       asp-route-Keyword="@ViewBag.SearchRequest?.Keyword"
                       asp-route-RoleId="@ViewBag.SearchRequest?.RoleId"
                       asp-route-DepartmentId="@ViewBag.SearchRequest?.DepartmentId"
                       asp-route-CompanyId="@ViewBag.SearchRequest?.CompanyId"
                       asp-route-IsActive="@ViewBag.SearchRequest?.IsActive">
                        Önceki
                    </a>
                </li>
            }

            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@i"
                       asp-route-Keyword="@ViewBag.SearchRequest?.Keyword"
                       asp-route-RoleId="@ViewBag.SearchRequest?.RoleId"
                       asp-route-DepartmentId="@ViewBag.SearchRequest?.DepartmentId"
                       asp-route-CompanyId="@ViewBag.SearchRequest?.CompanyId"
                       asp-route-IsActive="@ViewBag.SearchRequest?.IsActive">
                        @i
                    </a>
                </li>
            }

            @if (currentPage < totalPages)
            {
                <li class="page-item">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(currentPage + 1)"
                       asp-route-Keyword="@ViewBag.SearchRequest?.Keyword"
                       asp-route-RoleId="@ViewBag.SearchRequest?.RoleId"
                       asp-route-DepartmentId="@ViewBag.SearchRequest?.DepartmentId"
                       asp-route-CompanyId="@ViewBag.SearchRequest?.CompanyId"
                       asp-route-IsActive="@ViewBag.SearchRequest?.IsActive">
                        Sonraki
                    </a>
                </li>
            }

        </ul>
    </nav>

</div>

@section Scripts {
    <script>
        async function toggleUserStatus(userId, currentStatus) {

            const newStatus = !currentStatus;

            if (!confirm("Kullanıcı durumu değiştirilsin mi?")) return;

            const response = await fetch('/User/SetActiveStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: userId,
                    isActive: newStatus
                })
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("Durum değiştirilemedi!");
            }
        }

               async function deleteUser(userId) {

            if (!confirm("Bu kullanıcı silinsin mi?")) return;

            const response = await fetch(`/User/DeleteUser?id=${userId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("Kullanıcı silinemedi!");
            }
        }
    </script>
}
